# Прошивка роботизированного манипулятора Rene

Проект прошивки для манипулятора с четырьмя сервоприводами на базе STM32 BlackPill F411CE и фреймворка Arduino. Программа принимает JSON-команды от системы компьютерного зрения, управляет движением сервоприводов, забирает блок и кладёт его в стакан, отправляя статусы обратно по UART.

## Возможности
- Управляющий автомат, проходящий этапы: принятие команды, движение к кубику, захват, подъём в промежуточную точку, перемещение к стакану, отпускание и завершение, с постоянной отправкой статусов в виде JSON.【F:src/main.cpp†L219-L415】
- Кинематические расчёты для преобразования координат XYZ в углы сервоприводов с проверкой корректности входных данных.【F:src/mathCalc.cpp†L90-L169】
- Помощники для UART: чтение строк JSON, разбор полей команды и валидация координат цели от системы зрения.【F:src/comun.cpp†L12-L56】
- Утилиты для движения сервоприводов с учётом направлений вращения, базовых углов и глобальных целей по каждому приводу.【F:src/movementServo.cpp†L6-L31】【F:src/config.h†L17-L76】
- Возможность калибровки нулевых положений и светодиодные индикаторы на плате для подсказок по калибровке.【F:src/main.cpp†L9-L85】

## Структура проекта
- `src/main.cpp` — инициализация платы, настройка OCServo, обработка входящих команд и последовательность движений манипулятора.【F:src/main.cpp†L87-L415】
- `src/config.h` / `src/config.cpp` — определения ID сервоприводов, пинов UART и светодиодов, геометрические константы и глобальные состояния целевых позиций.【F:src/config.h†L17-L76】【F:src/config.cpp†L3-L25】
- `src/comun.h` / `src/comun.cpp` — функции для чтения JSON из UART и преобразования его в структурированные данные команды.【F:src/comun.h†L7-L29】【F:src/comun.cpp†L12-L56】
- `src/mathCalc.h` / `src/mathCalc.cpp` — расчёт углов по заданным координатам и проверка допустимости входных значений.【F:src/mathCalc.h†L4-L12】【F:src/mathCalc.cpp†L90-L169】
- `src/movementServo.h` / `src/movementServo.cpp` — функции задания целевых углов и пошагового перемещения каждого сервопривода.【F:src/movementServo.h†L4-L9】【F:src/movementServo.cpp†L6-L31】
- `platformio.ini` — конфигурация PlatformIO для платы STM32 BlackPill F411CE, загрузки через DFU и зависимости ArduinoJson.【F:platformio.ini†L11-L20】

## Аппаратные требования и зависимости
- Плата STM32 BlackPill F411CE; подключение к ПК с возможностью загрузки в режиме DFU и скоростью монитора 115200 бод.【F:platformio.ini†L11-L20】
- Четыре сервопривода OCServo, подключённые к `Serial1`, с идентификаторами `0x01`–`0x04`; параметры крутящего момента и скорости задаются при запуске прошивки.【F:src/config.cpp†L3-L25】【F:src/main.cpp†L96-L120】
- Библиотека ArduinoJson (загружается автоматически через PlatformIO).【F:platformio.ini†L17-L20】【F:src/comun.cpp†L12-L56】

## Сборка и прошивка
1. Установите [PlatformIO](https://platformio.org/install) (CLI или IDE).
2. Подключите плату STM32 BlackPill F411CE и переведите её в режим DFU при необходимости.
3. Выполните из корня репозитория:
   ```bash
   pio run
   pio run -t upload
   ```
4. Откройте монитор порта на 115200 бод, чтобы наблюдать статусы и ответы прошивки.

## Протокол обмена
- Система зрения отправляет построчные JSON-сообщения по UART `OPI_UART` (пины `PA3`/`PA2`). Сообщения со статусом `200` и полем `"target": "dual"` должны содержать объекты `block_position` и `cup_position` с полями `x`, `y`, `z` и `Ry`.【F:src/config.cpp†L14-L25】【F:src/comun.cpp†L30-L56】
- Прошивка отвечает JSON-объектами вида `{ "robot_status": "moving_to_cube" }`, отражая текущее состояние автомата.【F:src/main.cpp†L235-L415】
- Координаты задаются в миллиметрах относительно базовой высоты и длин звеньев, определённых в `config.h`.【F:src/config.h†L66-L71】

## Логика движения
1. После получения корректной команды манипулятор перемещается к обнаруженному кубику, закрывает захват, поднимается в промежуточную точку, движется над стаканом, отпускает объект и возвращается в исходное состояние.【F:src/main.cpp†L293-L415】
2. Углы сервоприводов вычисляются из координат с учётом ограничений; некорректные или нечисловые значения отклоняются с диагностикой по UART.【F:src/mathCalc.cpp†L102-L169】
3. Захват управляется четвёртым сервоприводом: используются функции `gripClose` и `gripOpen` для фиксации и освобождения блока.【F:src/main.cpp†L235-L245】【F:src/main.cpp†L359-L405】

## Калибровка и значения по умолчанию
- Кнопка на пине `PB5` запускает калибровку нулевых положений; светодиоды на `PB6` (красный), `PB7` (зелёный) и `PB4` (синий) подсказывают этапы процесса.【F:src/config.h†L53-L56】【F:src/main.cpp†L33-L85】
- Базовые углы и геометрические константы заданы в `config.h` и применяются при инициализации прошивки.【F:src/config.h†L58-L76】【F:src/config.cpp†L17-L25】

## Тестирование
Автоматических тестов нет; используйте сборку в PlatformIO и логи UART на железе для проверки работы.
